pipeline {

  agent {
    docker {
      image 'maven:3.9.9-eclipse-temurin-17'   // ‚ùó NOT alpine
      args '--user root -v /var/run/docker.sock:/var/run/docker.sock'
      reuseNode true
    }
  }

  environment {
    IMAGE_NAME   = 'ashwinsai22/springbootjavaapp'
    DOCKER_CREDS = 'docker'

    SONAR_HOST_URL = 'http://localhost:9000'
    ENFORCE_SONAR_QG = 'false'
  }

  stages {

    stage('Clean Workspace') {
      steps { cleanWs() }
    }

    stage('Checkout from Git') {
      steps {
        git branch: 'main',
            url: 'https://github.com/ashwinsai22/Jenkins-Zero-To-Hero.git'
      }
    }

    stage('Maven Build') {
      steps {
        sh '''
          cd java-maven-sonar-argocd-helm-k8s/spring-boot-app
          mvn clean package -DskipTests
        '''
      }
    }

    stage('SonarQube Analysis') {
      steps {
        withCredentials([string(credentialsId: 'Sonar-token', variable: 'SONAR_TOKEN')]) {
          sh '''
            cd java-maven-sonar-argocd-helm-k8s/spring-boot-app
            mvn sonar:sonar \
              -Dsonar.projectKey=SpringBootJavaApp \
              -Dsonar.projectName=SpringBootJavaApp \
              -Dsonar.host.url=${SONAR_HOST_URL} \
              -Dsonar.login=${SONAR_TOKEN}
          '''
        }
      }
    }

    stage('Quality Gate') {
      steps {
        script {
          def qg = waitForQualityGate abortPipeline: false
          echo "Quality Gate Status: ${qg.status}"

          if (qg.status != 'OK' && env.ENFORCE_SONAR_QG == 'true') {
            unstable("Quality Gate failed")
          }
        }
      }
    }

    stage('Docker Build & Push') {
      steps {
        withDockerRegistry(
          credentialsId: "${DOCKER_CREDS}",
          url: 'https://index.docker.io/v1/'
        ) {
          sh '''
            cd java-maven-sonar-argocd-helm-k8s/spring-boot-app
            docker build -t springbootjavaapp .
            docker tag springbootjavaapp $IMAGE_NAME:latest
            docker push $IMAGE_NAME:latest
          '''
        }
      }
    }

    stage('Trivy Image Scan') {
      steps {
        sh 'trivy image $IMAGE_NAME:latest || true'
      }
    }
  }

  post {
    always {
      emailext(
        subject: "Jenkins Build: ${JOB_NAME} #${BUILD_NUMBER} - ${currentBuild.currentResult}",
        body: """
Job: ${JOB_NAME}
Build Number: ${BUILD_NUMBER}
Status: ${currentBuild.currentResult}
URL: ${BUILD_URL}
""",
        to: 'ponugumatiashwinsai@gmail.com'
      )
    }
  }
}