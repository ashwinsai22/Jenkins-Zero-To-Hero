pipeline {

  agent {
    docker {
      image 'maven:3.9.9-eclipse-temurin-17-alpine'
      args '--user root -v /var/run/docker.sock:/var/run/docker.sock'
    }
  }

  environment {
    // üîß TOOLS
    SCANNER_HOME = tool 'sonar-scanner'

    // üê≥ DOCKER
    IMAGE_NAME   = 'ashwinsai22/springbootjavaapp'
    DOCKER_CREDS = 'docker'

    // üîç SONAR
    SONAR_ENV = 'sonar-server'

    // üîê SECURITY ENFORCEMENT FLAGS (CONFIGURABLE)
    ENFORCE_SONAR_QG = 'false'
    ENFORCE_OWASP    = 'false'
    ENFORCE_TRIVY_FS = 'false'
  }

  stages {

    stage('Clean Workspace') {
      steps {
        cleanWs()
      }
    }

    stage('Checkout from Git') {
      steps {
        git branch: 'main',
            url: 'https://github.com/ashwinsai22/Jenkins-Zero-To-Hero.git'
      }
    }

    /* ===================== SONARQUBE ===================== */

    stage('SonarQube Analysis') {
      steps {
        withSonarQubeEnv("${SONAR_ENV}") {
          sh '''
            $SCANNER_HOME/bin/sonar-scanner \
              -Dsonar.projectName=SpringBootJavaApp \
              -Dsonar.projectKey=SpringBootJavaApp
          '''
        }
      }
    }

    stage('Quality Gate') {
      steps {
        script {
          def qg = waitForQualityGate abortPipeline: false
          echo "Quality Gate Status: ${qg.status}"

          if (qg.status != 'OK' && env.ENFORCE_SONAR_QG == 'true') {
            unstable("Quality Gate failed: ${qg.status}")
          }
        }
      }
    }

    /* ===================== BUILD ===================== */

    stage('Install Dependencies') {
      steps {
        sh 'npm install || true'
      }
    }

    /* ===================== OWASP DEPENDENCY CHECK ===================== */

    stage('OWASP Dependency Check') {
      steps {
        withCredentials([
          string(credentialsId: 'nvd-api-key', variable: 'NVD_API_KEY')
        ]) {
          script {
            def status = sh(
              script: '''
                mkdir -p /var/lib/jenkins/odc-data
                ${tool 'DP-Check'}/bin/dependency-check.sh \
                  --scan ./ \
                  --data /var/lib/jenkins/odc-data \
                  --nvdApiKey "$NVD_API_KEY" \
                  --nvdApiDelay 3000 \
                  --disableNodeAudit \
                  --disableYarnAudit \
                  --format XML \
                  --out .
              ''',
              returnStatus: true
            )

            if (status != 0) {
              echo "OWASP Dependency Check issues detected"

              if (env.ENFORCE_OWASP == 'true') {
                unstable("OWASP Dependency Check failed")
              }
            }
          }
        }
      }
      post {
        always {
          script {
            if (fileExists('dependency-check-report.xml')) {
              dependencyCheckPublisher pattern: 'dependency-check-report.xml'
            }
          }
        }
      }
    }

    /* ===================== TRIVY FILESYSTEM ===================== */

    stage('Trivy Filesystem Scan') {
      steps {
        script {
          def status = sh(script: 'trivy fs .', returnStatus: true)

          if (status != 0) {
            echo "Trivy FS vulnerabilities found"

            if (env.ENFORCE_TRIVY_FS == 'true') {
              unstable("Trivy FS scan failed")
            }
          }
        }
      }
    }

    /* ===================== DOCKER ===================== */

    stage('Docker Build & Push') {
      steps {
        withDockerRegistry(
          credentialsId: "${DOCKER_CREDS}",
          url: 'https://index.docker.io/v1/'
        ) {
          sh '''
            docker build -t springbootjavaapp .
            docker tag springbootjavaapp $IMAGE_NAME:latest
            docker push $IMAGE_NAME:latest
          '''
        }
      }
    }

    stage('Trivy Image Scan') {
      steps {
        sh 'trivy image $IMAGE_NAME:latest'
      }
    }

    stage('Cleanup Local Images') {
      steps {
        sh '''
          docker rmi $IMAGE_NAME:latest || true
          docker rmi springbootjavaapp || true
        '''
      }
    }
  }

  post {
    always {
      emailext(
        subject: "Jenkins Build: ${JOB_NAME} #${BUILD_NUMBER} - ${currentBuild.currentResult}",
        body: """
Job: ${JOB_NAME}
Build Number: ${BUILD_NUMBER}
Status: ${currentBuild.currentResult}
URL: ${BUILD_URL}
""",
        to: 'ponugumatiashwinsai@gmail.com'
      )
    }
  }
}