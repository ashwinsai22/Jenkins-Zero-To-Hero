pipeline {
  agent any

  environment {
    IMAGE_NAME   = 'ashwinsai22/springbootjavaapp'
    DOCKER_CREDS = 'docker'
    SONAR_HOST_URL = 'http://localhost:9000'
  }

  stages {

    stage('Clean Workspace') {
      steps {
        cleanWs()
      }
    }

    stage('Checkout') {
      steps {
        git branch: 'main',
            url: 'https://github.com/ashwinsai22/Jenkins-Zero-To-Hero.git'
      }
    }

    stage('Build, Scan & Dockerize') {
      steps {
        script {
          docker.image('maven:3.9.9-eclipse-temurin-17')
            .inside('-u root -v /var/run/docker.sock:/var/run/docker.sock') {

              sh '''
                cd java-maven-sonar-argocd-helm-k8s/spring-boot-app
                mvn clean package -DskipTests
              '''

              withCredentials([string(credentialsId: 'Sonar-token', variable: 'SONAR_TOKEN')]) {
                sh '''
                  cd java-maven-sonar-argocd-helm-k8s/spring-boot-app
                  mvn sonar:sonar \
                    -Dsonar.projectKey=SpringBootJavaApp \
                    -Dsonar.projectName=SpringBootJavaApp \
                    -Dsonar.host.url=${SONAR_HOST_URL} \
                    -Dsonar.login=${SONAR_TOKEN}
                '''
              }

              withDockerRegistry(
                credentialsId: "${DOCKER_CREDS}",
                url: 'https://index.docker.io/v1/'
              ) {
                sh '''
                  cd java-maven-sonar-argocd-helm-k8s/spring-boot-app
                  docker build -t springbootjavaapp .
                  docker tag springbootjavaapp $IMAGE_NAME:latest
                  docker push $IMAGE_NAME:latest
                '''
              }
          }
        }
      }
    }
  }

  post {
    always {
      emailext(
        subject: "Jenkins Build: ${JOB_NAME} #${BUILD_NUMBER} - ${currentBuild.currentResult}",
        body: """
Job: ${JOB_NAME}
Build Number: ${BUILD_NUMBER}
Status: ${currentBuild.currentResult}
URL: ${BUILD_URL}
""",
        to: 'ponugumatiashwinsai@gmail.com'
      )
    }
  }
}